define(["durandal/system","durandal/app","durandal/activator","durandal/events","durandal/composition","plugins/history","knockout","jquery"],function(e,t,n,i,r,o,a,s){function u(e){return e=e.replace(y,"\\$&").replace(g,"(?:$1)?").replace(v,function(e,t){return t?e:"([^/]+)"}).replace(m,"(.*?)"),new RegExp("^"+e+"$",w?void 0:"i")}function l(e){var t=e.indexOf(":"),n=t>0?t-1:e.length;return e.substring(0,n)}function c(e,t){return-1!==e.indexOf(t,e.length-t.length)}function d(e,t){if(!e||!t)return!1;if(e.length!=t.length)return!1;for(var n=0,i=e.length;i>n;n++)if(e[n]!=t[n])return!1;return!0}function f(e){return e.queryString?e.fragment+"?"+e.queryString:e.fragment}var p,h,g=/\((.*?)\)/g,v=/(\(\?)?:\w+/g,m=/\*\w+/g,y=/[\-{}\[\]+?.,\\\^$|#\s]/g,b=/\/$/,w=!1,x="/",k="/",T=function(){function r(e,t){return e.router&&e.router.parent==t}function s(e){I&&I.config.isActive&&I.config.isActive(e)}function g(t,n,i){e.log("Navigation Complete",t,n);var o=e.getModuleId(j);o&&B.trigger("router:navigation:from:"+o),j=t,s(!1),I=n,s(!0);var a=e.getModuleId(j);switch(a&&B.trigger("router:navigation:to:"+a),r(t,B)||B.updateDocumentTitle(t,n),i){case"rootRouter":x=f(I);break;case"rootRouterWithChild":k=f(I);break;case"lastChildRouter":x=k}h.explicitNavigation=!1,h.navigatingBack=!1,B.trigger("router:navigation:complete",t,n,B)}function m(t,n){e.log("Navigation Cancelled"),B.activeInstruction(I),B.navigate(x,!1),$(!1),h.explicitNavigation=!1,h.navigatingBack=!1,B.trigger("router:navigation:cancelled",t,n,B)}function y(t){e.log("Navigation Redirecting"),$(!1),h.explicitNavigation=!1,h.navigatingBack=!1,B.navigate(t,{trigger:!0,replace:!0})}function w(t,n,i){h.navigatingBack=!h.explicitNavigation&&j!=i.fragment,B.trigger("router:route:activating",n,i,B);var o={canDeactivate:!B.parent};t.activateItem(n,i.params,o).then(function(e){if(e){var o=j,a=r(n,B),s="";if(B.parent?a||(s="lastChildRouter"):s=a?"rootRouterWithChild":"rootRouter",g(n,i,s),a){n.router.trigger("router:route:before-child-routes",n,i,B);var u=i.fragment;i.queryString&&(u+="?"+i.queryString),n.router.loadUrl(u)}o==n&&(B.attached(),B.compositionComplete())}else t.settings.lifecycleData&&t.settings.lifecycleData.redirect?y(t.settings.lifecycleData.redirect):m(n,i);p&&(p.resolve(),p=null)}).fail(function(t){e.error(t)})}function D(t,n,i){var r=B.guardRoute(n,i);r||""===r?r.then?r.then(function(r){r?e.isString(r)?y(r):w(t,n,i):m(n,i)}):e.isString(r)?y(r):w(t,n,i):m(n,i)}function C(e,t,n){B.guardRoute?D(e,t,n):w(e,t,n)}function S(e){return I&&I.config.moduleId==e.config.moduleId&&j&&(j.canReuseForRoute&&j.canReuseForRoute.apply(j,e.params)||!j.canReuseForRoute&&j.router&&j.router.loadUrl)}function _(){if(!$()){var t=P.shift();if(P=[],t)if($(!0),B.activeInstruction(t),B.trigger("router:navigation:processing",t,B),S(t)){var i=n.create();i.forceActiveItem(j),i.settings.areSameItem=R.settings.areSameItem,i.settings.findChildActivator=R.settings.findChildActivator,C(i,j,t)}else t.config.moduleId?e.acquire(t.config.moduleId).then(function(n){var i=e.resolveObject(n);t.config.viewUrl&&(i.viewUrl=t.config.viewUrl),C(R,i,t)}).fail(function(n){m(null,t),e.error("Failed to load routed module ("+t.config.moduleId+"). Details: "+n.message,n)}):C(R,{viewUrl:t.config.viewUrl,canReuseForRoute:function(){return!0}},t)}}function E(e){P.unshift(e),_()}function A(e,t,n){for(var i=e.exec(t).slice(1),r=0;r<i.length;r++){var o=i[r];i[r]=o?decodeURIComponent(o):null}var a=B.parseQueryString(n);return a&&i.push(a),{params:i,queryParams:a}}function N(t){B.trigger("router:route:before-config",t,B),e.isRegExp(t.route)?t.routePattern=t.route:(t.title=t.title||B.convertRouteToTitle(t.route),t.viewUrl||(t.moduleId=t.moduleId||B.convertRouteToModuleId(t.route)),t.hash=t.hash||B.convertRouteToHash(t.route),t.hasChildRoutes&&(t.route=t.route+"*childRoutes"),t.routePattern=u(t.route)),t.isActive=t.isActive||a.observable(!1),B.trigger("router:route:after-config",t,B),B.routes.push(t),B.route(t.routePattern,function(e,n){var i=A(t.routePattern,e,n);E({fragment:e,queryString:n,config:t,params:i.params,queryParams:i.queryParams})})}function M(t){if(e.isArray(t.route))for(var n=t.isActive||a.observable(!1),i=0,r=t.route.length;r>i;i++){var o=e.extend({},t);o.route=t.route[i],o.isActive=n,i>0&&delete o.nav,N(o)}else N(t);return B}function O(e){var n=a.unwrap(t.title);document.title=n?e+" | "+n:e}var j,I,P=[],$=a.observable(!1),R=n.create(),B={handlers:[],routes:[],navigationModel:a.observableArray([]),activeItem:R,isNavigating:a.computed(function(){var e=R(),t=$(),n=e&&e.router&&e.router!=B&&e.router.isNavigating()?!0:!1;return t||n}),activeInstruction:a.observable(null),__router__:!0};i.includeIn(B),R.settings.areSameItem=function(e,t,n,i){return e==t?d(n,i):!1},R.settings.findChildActivator=function(e){return e&&e.router&&e.router.parent==B?e.router.activeItem:null},B.parseQueryString=function(t){var n,i;if(!t)return null;if(i=t.split("&"),0==i.length)return null;n={};for(var r=0;r<i.length;r++){var o=i[r];if(""!==o){var a=o.split(/=(.+)?/),s=a[0],u=a[1]&&decodeURIComponent(a[1].replace(/\+/g," ")),l=n[s];l?e.isArray(l)?l.push(u):n[s]=[l,u]:n[s]=u}}return n},B.route=function(e,t){B.handlers.push({routePattern:e,callback:t})},B.loadUrl=function(t){var n=B.handlers,i=null,r=t,a=t.indexOf("?");if(-1!=a&&(r=t.substring(0,a),i=t.substr(a+1)),B.relativeToParentRouter){var s=this.parent.activeInstruction();r=-1==a?s.params.join("/"):s.params.slice(0,-1).join("/"),r&&"/"==r.charAt(0)&&(r=r.substr(1)),r||(r=""),r=r.replace("//","/").replace("//","/")}r=r.replace(b,"");for(var u=0;u<n.length;u++){var l=n[u];if(l.routePattern.test(r))return l.callback(r,i),!0}return e.log("Route Not Found",t,I),B.trigger("router:route:not-found",t,B),B.parent&&(x=k),o.navigate(x,{trigger:!1,replace:!0}),h.explicitNavigation=!1,h.navigatingBack=!1,!1};var H;return a.isObservable(t.title)&&t.title.subscribe(function(){var e=B.activeInstruction(),t=null!=e?a.unwrap(e.config.title):"";O(t)}),B.updateDocumentTitle=function(e,n){var i=a.unwrap(t.title),r=n.config.title;H&&H.dispose(),r?a.isObservable(r)?(H=r.subscribe(O),O(r())):O(r):i&&(document.title=i)},B.navigate=function(t,n){return t&&-1!=t.indexOf("://")?(window.location.href=t,!0):((void 0===n||e.isBoolean(n)&&n||e.isObject(n)&&n.trigger)&&(h.explicitNavigation=!0),(e.isBoolean(n)&&!n||n&&void 0!=n.trigger&&!n.trigger)&&(x=t),o.navigate(t,n))},B.navigateBack=function(){o.navigateBack()},B.attached=function(){B.trigger("router:navigation:attached",j,I,B)},B.compositionComplete=function(){$(!1),B.trigger("router:navigation:composition-complete",j,I,B),_()},B.convertRouteToHash=function(e){if(e=e.replace(/\*.*$/,""),B.relativeToParentRouter){var t=B.parent.activeInstruction(),n=e?t.config.hash+"/"+e:t.config.hash;return o._hasPushState&&(n="/"+n),n=n.replace("//","/").replace("//","/")}return o._hasPushState?e:"#"+e},B.convertRouteToModuleId=function(e){return l(e)},B.convertRouteToTitle=function(e){var t=l(e);return t.substring(0,1).toUpperCase()+t.substring(1)},B.map=function(t,n){if(e.isArray(t)){for(var i=0;i<t.length;i++)B.map(t[i]);return B}return e.isString(t)||e.isRegExp(t)?(n?e.isString(n)&&(n={moduleId:n}):n={},n.route=t):n=t,M(n)},B.buildNavigationModel=function(t){for(var n=[],i=B.routes,r=t||100,o=0;o<i.length;o++){var a=i[o];a.nav&&(e.isNumber(a.nav)||(a.nav=++r),n.push(a))}return n.sort(function(e,t){return e.nav-t.nav}),B.navigationModel(n),B},B.mapUnknownRoutes=function(t,n){var i="*catchall",r=u(i);return B.route(r,function(a,s){var u=A(r,a,s),l={fragment:a,queryString:s,config:{route:i,routePattern:r},params:u.params,queryParams:u.queryParams};if(t)if(e.isString(t))l.config.moduleId=t,n&&o.navigate(n,{trigger:!1,replace:!0});else if(e.isFunction(t)){var c=t(l);if(c&&c.then)return c.then(function(){B.trigger("router:route:before-config",l.config,B),B.trigger("router:route:after-config",l.config,B),E(l)}),void 0}else l.config=t,l.config.route=i,l.config.routePattern=r;else l.config.moduleId=a;B.trigger("router:route:before-config",l.config,B),B.trigger("router:route:after-config",l.config,B),E(l)}),B},B.reset=function(){return I=j=void 0,B.handlers=[],B.routes=[],B.off(),delete B.options,B},B.makeRelative=function(t){return e.isString(t)&&(t={moduleId:t,route:t}),t.moduleId&&!c(t.moduleId,"/")&&(t.moduleId+="/"),t.route&&!c(t.route,"/")&&(t.route+="/"),t.fromParent&&(B.relativeToParentRouter=!0),B.on("router:route:before-config").then(function(e){t.moduleId&&(e.moduleId=t.moduleId+e.moduleId),t.route&&(e.route=""===e.route?t.route.substring(0,t.route.length-1):t.route+e.route)}),t.dynamicHash&&(B.on("router:route:after-config").then(function(e){e.routePattern=u(e.route?t.dynamicHash+"/"+e.route:t.dynamicHash),e.dynamicHash=e.dynamicHash||a.observable(e.hash)}),B.on("router:route:before-child-routes").then(function(e,t){for(var n=e.router,i=0;i<n.routes.length;i++){var r=n.routes[i],o=t.params.slice(0);r.hash=n.convertRouteToHash(r.route).replace(v,function(e){return o.length>0?o.shift():e}),r.dynamicHash(r.hash)}})),B},B.createChildRouter=function(){var e=T();return e.parent=B,e},B};return h=T(),h.explicitNavigation=!1,h.navigatingBack=!1,h.makeRoutesCaseSensitive=function(){w=!0},h.targetIsThisWindow=function(e){var t=s(e.target).attr("target");return!t||t===window.name||"_self"===t||"top"===t&&window===window.top?!0:!1},h.activate=function(t){return e.defer(function(n){if(p=n,h.options=e.extend({routeHandler:h.loadUrl},h.options,t),o.activate(h.options),o._hasPushState)for(var i=h.routes,r=i.length;r--;){var a=i[r];a.hash=a.hash.replace("#","/")}var u=h.options.root&&new RegExp("^"+h.options.root+"/");s(document).delegate("a","click",function(e){if(o._hasPushState){if(!e.altKey&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&h.targetIsThisWindow(e)){var t=s(this).attr("href");null==t||"#"===t.charAt(0)||/^[a-z]+:/i.test(t)||(h.explicitNavigation=!0,e.preventDefault(),u&&(t=t.replace(u,"")),o.navigate(t))}}else h.explicitNavigation=!0}),o.options.silent&&p&&(p.resolve(),p=null)}).promise()},h.deactivate=function(){o.deactivate()},h.install=function(){a.bindingHandlers.router={init:function(){return{controlsDescendantBindings:!0}},update:function(e,t,n,i,o){var s=a.utils.unwrapObservable(t())||{};if(s.__router__)s={model:s.activeItem(),attached:s.attached,compositionComplete:s.compositionComplete,activate:!1};else{var u=a.utils.unwrapObservable(s.router||i.router)||h;s.model=u.activeItem(),s.attached=u.attached,s.compositionComplete=u.compositionComplete,s.activate=!1}r.compose(e,s,o)}},a.virtualElements.allowedBindings.router=!0},h});