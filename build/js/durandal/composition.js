define(["durandal/system","durandal/viewLocator","durandal/binder","durandal/viewEngine","durandal/activator","jquery","knockout"],function(e,t,n,i,r,o,a){function s(t,n,i){try{if(t.onError)try{t.onError(n,i)}catch(r){e.error(r)}else e.error(n)}finally{u(t,i,!0)}}function l(e){for(var t=[],n={childElements:t,activeView:null},i=a.virtualElements.firstChild(e);i;)1==i.nodeType&&(t.push(i),i.getAttribute(k)&&(n.activeView=i)),i=a.virtualElements.nextSibling(i);return n.activeView||(n.activeView=t[0]),n}function u(e,t,n){if(D--,0===D){var i=T;T=[],n||setTimeout(function(){for(var n=i.length;n--;)try{i[n]()}catch(r){s(e,r,t)}},1)}c(e)}function c(e){delete e.activeView,delete e.viewElements}function d(t,n,i,r){if(i)n();else if(t.activate&&t.model&&t.model.activate){var o;try{o=e.isArray(t.activationData)?t.model.activate.apply(t.model,t.activationData):t.model.activate(t.activationData),o&&o.then?o.then(n,function(e){s(t,e,r),n()}):o||void 0===o?n():u(t,r)}catch(a){s(t,a,r)}}else n()}function f(t,n){var t=this;if(t.activeView&&t.activeView.removeAttribute(k),t.child)try{t.model&&t.model.attached&&(t.composingNewView||t.alwaysTriggerAttach)&&t.model.attached(t.child,t.parent,t),t.attached&&t.attached(t.child,t.parent,t),t.child.setAttribute(k,!0),t.composingNewView&&t.model&&t.model.detached&&a.utils.domNodeDisposal.addDisposeCallback(t.child,function(){try{t.model.detached(t.child,t.parent,t)}catch(e){s(t,e,n)}})}catch(i){s(t,i,n)}t.triggerAttach=e.noop}function p(t){if(e.isString(t.transition)){if(t.activeView){if(t.activeView==t.child)return!1;if(!t.child)return!0;if(t.skipTransitionOnSameViewId){var n=t.activeView.getAttribute("data-view"),i=t.child.getAttribute("data-view");return n!=i}}return!0}return!1}function h(e){for(var t=0,n=e.length,i=[];n>t;t++){var r=e[t].cloneNode(!0);i.push(r)}return i}function g(t){var n=h(t.parts),i=w.getParts(n),r=w.getParts(t.child);for(var a in i){var s=r[a];s||(s=o('[data-part="'+a+'"]',t.child).get(0))?s.parentNode.replaceChild(i[a],s):e.log("Could not find part to override: "+a)}}function v(t){var n,i,r=a.virtualElements.childNodes(t.parent);if(!e.isArray(r)){var o=[];for(n=0,i=r.length;i>n;n++)o[n]=r[n];r=o}for(n=1,i=r.length;i>n;n++)a.removeNode(r[n])}function m(e){a.utils.domData.set(e,E,e.style.display),e.style.display="none"}function y(e){var t=a.utils.domData.get(e,E);e.style.display="none"===t?"block":t}function b(e){var t=e.getAttribute("data-bind");if(!t)return!1;for(var n=0,i=A.length;i>n;n++)if(t.indexOf(A[n])>-1)return!0;return!1}var w,x={},k="data-active-view",T=[],D=0,C="durandal-composition-data",S="data-part",_=["model","view","transition","area","strategy","activationData","onError"],E="durandal-visibility-data",A=["compose:"],N={complete:function(e){T.push(e)}};return w={composeBindings:A,convertTransitionToModuleId:function(e){return"transitions/"+e},defaultTransitionName:null,current:N,addBindingHandler:function(e,t,n){var i,r,o="composition-handler-"+e;t=t||a.bindingHandlers[e],n=n||function(){return void 0},r=a.bindingHandlers[e]={init:function(e,i,r,s,l){if(D>0){var u={trigger:a.observable(null)};w.current.complete(function(){t.init&&t.init(e,i,r,s,l),t.update&&(a.utils.domData.set(e,o,t),u.trigger("trigger"))}),a.utils.domData.set(e,o,u)}else a.utils.domData.set(e,o,t),t.init&&t.init(e,i,r,s,l);return n(e,i,r,s,l)},update:function(e,t,n,i,r){var s=a.utils.domData.get(e,o);return s.update?s.update(e,t,n,i,r):(s.trigger&&s.trigger(),void 0)}};for(i in t)"init"!==i&&"update"!==i&&(r[i]=t[i])},getParts:function(e,t){if(t=t||{},!e)return t;void 0===e.length&&(e=[e]);for(var n=0,i=e.length;i>n;n++){var r,o=e[n];o.getAttribute&&(r=o.getAttribute(S),r&&(t[r]=o),o.hasChildNodes()&&!b(o)&&w.getParts(o.childNodes,t))}return t},cloneNodes:h,finalize:function(t,i){if(void 0===t.transition&&(t.transition=this.defaultTransitionName),t.child||t.activeView)if(p(t)){var r=this.convertTransitionToModuleId(t.transition);e.acquire(r).then(function(e){t.transition=e,e(t).then(function(){if(t.cacheViews){if(t.activeView){var e=n.getBindingInstruction(t.activeView);e&&void 0!=e.cacheViews&&!e.cacheViews?a.removeNode(t.activeView):m(t.activeView)}}else t.child?v(t):a.virtualElements.emptyNode(t.parent);t.child&&y(t.child),t.triggerAttach(t,i),u(t,i)})}).fail(function(e){s(t,"Failed to load transition ("+r+"). Details: "+e.message,i)})}else{if(t.child!=t.activeView){if(t.cacheViews&&t.activeView){var o=n.getBindingInstruction(t.activeView);!o||void 0!=o.cacheViews&&!o.cacheViews?a.removeNode(t.activeView):m(t.activeView)}t.child?(t.cacheViews||v(t),y(t.child)):t.cacheViews||a.virtualElements.emptyNode(t.parent)}t.triggerAttach(t,i),u(t,i)}else t.cacheViews||a.virtualElements.emptyNode(t.parent),t.triggerAttach(t,i),u(t,i)},bindAndShow:function(e,t,r,o){r.child=e,r.parent.__composition_context=r,r.composingNewView=r.cacheViews?-1==a.utils.arrayIndexOf(r.viewElements,e):!0,d(r,function(){if(r.parent.__composition_context==r){if(delete r.parent.__composition_context,r.binding&&r.binding(r.child,r.parent,r),r.preserveContext&&r.bindingContext)r.composingNewView&&(r.parts&&g(r),m(e),a.virtualElements.prepend(r.parent,e),n.bindContext(r.bindingContext,e,r.model,r.as));else if(e){var o=r.model||x,s=a.dataFor(e);if(s!=o){if(!r.composingNewView)return a.removeNode(e),i.createView(e.getAttribute("data-view")).then(function(e){w.bindAndShow(e,t,r,!0)}),void 0;r.parts&&g(r),m(e),a.virtualElements.prepend(r.parent,e),n.bind(o,e)}}w.finalize(r,t)}else u(r,t)},o,t)},defaultStrategy:function(e){return t.locateViewForObject(e.model,e.area,e.viewElements)},getSettings:function(t){var n,o=t(),s=a.utils.unwrapObservable(o)||{},l=r.isActivator(o);if(e.isString(s))return s=i.isViewUrl(s)?{view:s}:{model:s,activate:!l};if(n=e.getModuleId(s))return s={model:s,activate:!l};!l&&s.model&&(l=r.isActivator(s.model));for(var u in s)s[u]=-1!=a.utils.arrayIndexOf(_,u)?a.utils.unwrapObservable(s[u]):s[u];return l?s.activate=!1:void 0===s.activate&&(s.activate=!0),s},executeStrategy:function(e,t){e.strategy(e).then(function(n){w.bindAndShow(n,t,e)})},inject:function(n,i){return n.model?n.view?(t.locateView(n.view,n.area,n.viewElements).then(function(e){w.bindAndShow(e,i,n)}),void 0):(n.strategy||(n.strategy=this.defaultStrategy),e.isString(n.strategy)?e.acquire(n.strategy).then(function(e){n.strategy=e,w.executeStrategy(n,i)}).fail(function(e){s(n,"Failed to load view strategy ("+n.strategy+"). Details: "+e.message,i)}):this.executeStrategy(n,i),void 0):(this.bindAndShow(null,i,n),void 0)},compose:function(n,i,r,o){D++,o||(i=w.getSettings(function(){return i},n)),i.compositionComplete&&T.push(function(){i.compositionComplete(i.child,i.parent,i)}),T.push(function(){i.composingNewView&&i.model&&i.model.compositionComplete&&i.model.compositionComplete(i.child,i.parent,i)});var a=l(n);i.activeView=a.activeView,i.parent=n,i.triggerAttach=f,i.bindingContext=r,i.cacheViews&&!i.viewElements&&(i.viewElements=a.childElements),i.model?e.isString(i.model)?e.acquire(i.model).then(function(t){i.model=e.resolveObject(t),w.inject(i,n)}).fail(function(e){s(i,"Failed to load composed module ("+i.model+"). Details: "+e.message,n)}):w.inject(i,n):i.view?(i.area=i.area||"partial",i.preserveContext=!0,t.locateView(i.view,i.area,i.viewElements).then(function(e){w.bindAndShow(e,n,i)})):this.bindAndShow(null,n,i)}},a.bindingHandlers.compose={init:function(){return{controlsDescendantBindings:!0}},update:function(e,t,n,r,o){var s=w.getSettings(t,e);if(s.mode){var l=a.utils.domData.get(e,C);if(!l){var u=a.virtualElements.childNodes(e);l={},"inline"===s.mode?l.view=i.ensureSingleElement(u):"templated"===s.mode&&(l.parts=h(u)),a.virtualElements.emptyNode(e),a.utils.domData.set(e,C,l)}"inline"===s.mode?s.view=l.view.cloneNode(!0):"templated"===s.mode&&(s.parts=l.parts),s.preserveContext=!0}w.compose(e,s,o,!0)}},a.virtualElements.allowedBindings.compose=!0,w});